<!DOCTYPE html>
<html lang="en">

<head>
    <% include ../partials/head %>
</head>

<body class="bg-dark">

    <header>
        <%- include('../partials/nav', {active: 'Search'}) %>
    </header>
    <section class="container-flat mt-4 text-white">
        <div class="flat">
            <h3 class="text-center">Search for product(s)</h3>
            <form class="text-center ">
                <div class="form-group row justify-content-center">
                    <div class="col-xs-2 card bg-secondary p-4 mt-2 notiflix">
                            <input type="text" class="form-control text-center" id="search" aria-describedby="searchHelp"
                            placeholder="gtin, brand, name"/>
                        <small id="searchHelp" class="form-text">To scrap new product, please provide a valid gtin.</small>
                        <p class="mt-4">Results will be displayed bellow</p>
                    </div>
                    <!-- <label for="exampleInputEmail1">Email address</label> -->
                   
                </div>
                
            </form>
            <div class="mt-4">
                <h3 class="text-center">Results</h3>
                <div class="pr-4 pl-4 results card-columns" id="results"></div>

                </div>
                <div id="resultsText">

                </div>
            </div>
        </div>
    </section>

    <footer>
        <% include ../partials/footer %>
    </footer>
    <script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
    <script>
        const socket = io();

        function insertResult(data, req) {
            $('#results').html('');
            $('#resultsText').html('');
            if(data.length > 0) {
                for(let i = 0; i < data.length; i++) {
                    $('#results').append(`
                        <div class="card mb-2 mt-2 bg-secondary">
                            <img src="${data[i].images[0]}" class="card-img-top product-img bg-white d-block text-center"
                                    alt="Image not available yet.">
                                <div class="card-body pt-1">
                                    <h5 class="card-title mb-0">${data[i].name}</h5>
                                    <small class="">${data[i].gtin}</small>
                                    <br/>
                                    <a href="/products/${data[i].gtin}" class="d-inline-block mt-4 notiflix-btn notiflix-btn-confirm">More details</a>
                                </div>
                            </div>
                    `)
                }
            } else if ((/^\d+$/.test(req.term)) && (req.term.length == 8 || req.term.length == 12 || req.term.length == 13 || req.term.length == 14)) {
                $('#resultsText').append(`
                    <h5 class="text-center text-success mt-4">This is a valid gtin code...</h5>
                    <div class="text-center mt-3 mb-5">
                        <a href="/products/${req.term}" class="notiflix-btn notiflix-btn-confirm">Scrap it !</a>
                    </div>
                    `)
            } else {
                $('#resultsText').append(`<h3 class="text-center mt-4">No product found...</h3>`)
            }
        }

        $('#search').autocomplete({
            source: (req, res) => {
                $.ajax({
                    url: '/search/auto',
                    type: 'GET',
                    data: req,
                    success: (data) => {
                        insertResult(data, req);
                        console.log(req);
                        
                    }
                })
            },
            minLength: 1
        })
    </script>
</body>

</html>